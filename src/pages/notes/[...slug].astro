---
import ContentLayout from '../../layouts/ContentLayout.astro';
import { getCollection, getEntry, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  return notes.map(note => ({
    params: { slug: note.slug },
    props: { slug: note.slug },
  }));
}

const { slug } = Astro.props;
const note = await getEntry('notes', slug) as CollectionEntry<'notes'>;
const { Content } = await render(note);

// 获取所有笔记并按日期排序，获取最新的3篇（排除当前笔记）
const allNotes = await getCollection('notes');
const filteredNotes = allNotes.filter(n => n.slug !== slug);
const sortedNotes = filteredNotes.sort((a, b) => {
  const dateA = a.data.date ? new Date(a.data.date).getTime() : 0;
  const dateB = b.data.date ? new Date(b.data.date).getTime() : 0;
  return dateB - dateA;
});
const latestNotes = sortedNotes.slice(0, 3);

// 获取随机推荐内容（示例数据）
const randomRecommendations = [
  { title: "推荐作品1", url: "/portfolio", type: "作品" },
  { title: "推荐工具1", url: "/tools", type: "工具" },
  { title: "推荐笔记1", url: "/notes", type: "笔记" },
];

// 获取最新文章（笔记合集）
const latestArticles = latestNotes.map(note => ({
  title: note.data.title,
  url: `/notes/${note.slug}`,
  date: note.data.date ? new Date(note.data.date).toLocaleDateString('zh-CN') : '未知日期'
}));

// 获取热门标签（示例数据）
const popularTags = [
  { name: "前端", count: 15, url: "/tags/frontend" },
  { name: "设计", count: 12, url: "/tags/design" },
  { name: "React", count: 10, url: "/tags/react" },
  { name: "Node.js", count: 8, url: "/tags/nodejs" },
];
---

<ContentLayout 
  title={note.data.title}
  description={note.data.description || ''}
  breadcrumbLinks={[
    { href: '/', label: '首页' },
    { href: '/notes', label: '笔记' },
    { href: '#', label: '正文' }
  ]}
  randomRecommendations={randomRecommendations}
  latestArticles={latestArticles}
  popularTags={popularTags}
>
  <article class="note-detail">
    <h1>{note.data.title}</h1>
    
    <div class="note-content">
      <Content />
    </div>
  </article>
</ContentLayout>

<!-- 所有样式已移至global.css -->