<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>内容管理系统</title>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    <link rel="stylesheet" href="./custom.css" />
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <!-- Netlify CMS will be injected here -->
    <script>
      // 注册自定义媒体库组件以避免错误
      CMS.registerMediaLibrary({
        name: 'static',
        init: () => ({
          show: (options = {}) => {
            console.log('Static media library show called with options:', options);
            return Promise.resolve();
          },
          hide: () => {
            console.log('Static media library hide called');
            return Promise.resolve();
          },
          onClearControl: () => {
            console.log('Static media library onClearControl called');
            return Promise.resolve();
          },
          enableStandalone: () => false,
        })
      });
      
      // 初始化 Netlify Identity Widget
      if (document.location.hostname === "localhost") {
        // 本地开发环境
        CMS.init();
      } else {
        // 生产环境
        CMS.init({
          config: {
            backend: {
              name: 'git-gateway',
              branch: 'main',
              site_domain: 'gautown.top'
            },
            media_library: {
              name: 'static'
            }
          }
        });
      }
      
      // 初始化 Netlify Identity Widget
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
        
        // 自动初始化
        window.netlifyIdentity.init();
      }
      
      // 如果用户已登录，重定向到管理页面
      if (window.netlifyIdentity && window.netlifyIdentity.currentUser()) {
        document.location.href = "/admin/";
      }
      
      // 确保 Netlify Identity Widget 正确显示
      document.addEventListener('DOMContentLoaded', function() {
        if (window.netlifyIdentity) {
          window.netlifyIdentity.init();
        }
      });
    </script>
  </body>
</html>